package de.culture4life.luca.testing.provider.opentestcheck;

import com.google.android.gms.common.util.Hex;

import de.culture4life.luca.registration.RegistrationData;
import de.culture4life.luca.testing.TestResult;
import de.culture4life.luca.testing.TestResultParsingException;
import de.culture4life.luca.testing.TestResultVerificationException;

import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.annotation.Config;

import java.nio.charset.StandardCharsets;

import androidx.test.runner.AndroidJUnit4;
import io.reactivex.rxjava3.core.Single;

import static org.junit.Assert.assertEquals;

@Config(sdk = 28)
@RunWith(AndroidJUnit4.class)
public class OpenTestCheckTestResultProviderTest {

    public static final String VALID_TEST_RESULT_TICKET_IO = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMTZhM2U0YjkyY2E0NjYwYzQxYjg4MDU3Mjc2YzM1ZGUzOGI2ZGZlN2FkY2VkMzZjZGUxZjA3OWE2ODY4YTFhMyIsInQiOjE2MjA4MDIwNTIsImMiOiJmIiwiciI6Im4iLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJEci4gRGF2aWQiLCJlZCI6ImhvaktYcFErMERhZGpaWWlUdktWWmR6d21WVDcyWHU1R2xZTXNVYnJPN2M3REhZY1c1Y1Y2ajhaalpMRVpGTE9wS3FTK1AzZllzTEJtMzRJMUREV09sR2x6N1RrUHROeG5cL3JhcnN3ZVA0bkhlUzhhcFVsUEdwUnAyVEl2R1E9PSJ9.IKHZusBnGBc12b3by5SL6FXOdeufyU_9arwmx9_L0JOlXXY1Q9HpS5oCzLJ9iy5Wlm7wvYkao6CT49fgaDzmQL4zTubQo7xpJGc19EWIL0z5o_HaYkN74KrxG114VsLLVPgps50MzYv_qvhr0qe5DABHFswUMKGhyLxJyZFsMfMPI4WY-REFO6zWCTg9uS4mLDEXz1weJ_0ZJj4j5jW-3FzX-Hzq9iovLT7PyVIiK318iP0pc7vSP9V-8bvgqnHvinKUEw0FdxjRN0V_Isd8M2E5Xn64TvUeISMd6f5Nk3KytIW5jTaZg_E7z-ldzz5w12ZH3uITx7ocxjahdChE2w";
    public static final String EXPIRED_TEST_RESULT_TICKET_IO = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiYTZhODVkODUyZTA1OTFkZjM2ODUwZTFmMDc1MTFkZWE0MmFjYjAxMjljNzFkZjk1ZTM2YWVkNzhkYWU5ZTNhOCIsInQiOjE2MjAyNzU3NDAsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBIYW5zIiwiZWQiOiJpTHhpSFZzck5oZFh6UDNoeEZkd1p3Z1ludDVGTUYzVXo3MmJHOHMxcytxV2hzZEgxeGJ4R1Z0SHZzbVwvZkRLXC9zWUczdVwvR0pKd3BXTldSZ2xHOGs0SnhyKytCeDBwWStudjlqb0diWm5lWEt4Ulp6T3RSWnlxeEY2cExrIn0.WocR6aa8EX1WEOKxES_gFnvfJnrg6xLzm1cwZ453StqubQPlMjG-JdZofVa4NgTRUCrxDvcQd8M-wQxksM79Dpy0_tOP2mHA59V5LTsVSVzk7teS6cTGhy1nGqZIfu3ORvOqTvxJmuBtT-Z8TGnJzkTTMNx_t8mPSBTHCJX9YQE0APXSnusiy5LF4iQTpYrgKEH0IZTT4gIx6-SbNpkuVmJE6RxVvjAdnlnTS6lqtr9jplaNw8L6gDw5s0zZ5z8xytuWvceRap_GOTeCxdmg-8f4EghjMJFea8T5WwfZY4BDJbEawsAcOY-ErS4Ey3M_W8PYaPTZWmClOiJGsCeU8w";
    public static final String VALID_TEST_RESULT_TICKET_IO_2 = "https://testverify.io/v1#eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiYTZhODVkODUyZTA1OTFkZjM2ODUwZTFmMDc1MTFkZWE0MmFjYjAxMjljNzFkZjk1ZTM2YWVkNzhkYWU5ZTNhOCIsInQiOjE2MjAyNzU3NDAsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBIYW5zIiwiZWQiOiJpTHhpSFZzck5oZFh6UDNoeEZkd1p3Z1ludDVGTUYzVXo3MmJHOHMxcytxV2hzZEgxeGJ4R1Z0SHZzbVwvZkRLXC9zWUczdVwvR0pKd3BXTldSZ2xHOGs0SnhyKytCeDBwWStudjlqb0diWm5lWEt4Ulp6T3RSWnlxeEY2cExrIn0.WocR6aa8EX1WEOKxES_gFnvfJnrg6xLzm1cwZ453StqubQPlMjG-JdZofVa4NgTRUCrxDvcQd8M-wQxksM79Dpy0_tOP2mHA59V5LTsVSVzk7teS6cTGhy1nGqZIfu3ORvOqTvxJmuBtT-Z8TGnJzkTTMNx_t8mPSBTHCJX9YQE0APXSnusiy5LF4iQTpYrgKEH0IZTT4gIx6-SbNpkuVmJE6RxVvjAdnlnTS6lqtr9jplaNw8L6gDw5s0zZ5z8xytuWvceRap_GOTeCxdmg-8f4EghjMJFea8T5WwfZY4BDJbEawsAcOY-ErS4Ey3M_W8PYaPTZWmClOiJGsCeU8w";
    public static final String VALID_TEST_RESULT_TICKET_IO_SPECIAL_CHARS = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiZjQyMGYwMmYxYjk0NjkyZmRkZjkwOTUwNjk4N2U1NDdiYjg2OWMzYWMzMGM5NWQ5MWM3Y2JlNWYxZDJjZjE1ZSIsInQiOjE2MjA5ODYyNzgsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBEci4gQ29yb25hZmlnaHQiLCJlZCI6ImJXaitIMkkxbWtUU2hmbVZGSlwvYlFpQWVuRVAyTk44OTFLUEloeDdyNlRTbEdnTndFblVKTERsTVJSYnd3TVJcL0xxOTBldzk2N1o2aWozc3NYcjYyaXprWVU0bG96NWh1WWZUSVI2TndkQktJWCt3cXloTVE0VjBPcU5kekc3WW1rb0k9In0.BJXB91NB0RDQhgx2nrvUltasO-7OgT_7Ll9JxguS_TuLmIwrTJZ0yeurIChCYqK6j4xWnlpt-BzuW_a7ZSrgOVILxSZ7UUBGjXlEdfJAyudWDiAIVg_h_yA0TPK2R7Ngpope3AaY5wjj99CairtugPB1Bb3a7hn_Hmx8nrqCUVMsEqlZC42DaKxnGyjJT2tTNrc9SZ9SUvCSTSEbcNVTROqfszl5rfe7AfHtR_OK2gQhs56DFB1YYznkIP4Wz6PJMPjKT6sC6WPgb08vh4eunm_RH_b4kbd4qTioTqBEJWDI_lKthpb6sXtnWbgzeQA7FpkfEKjmhTJbkPZ_wuPmlA";
    public static final String VALID_TEST_RESULT_SODA = "eyJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiODExYTlhNjk0N2E5NGUxYjhhNjE3OTM4NWVmMmIwYTA3MzE4Zjk4MjRhMzZjZTVkYmE5YmY4ZGVkZDNmZGFmNyIsInQiOjE2MjA2NDYxODAsImMiOiJmIiwiciI6Im4iLCJsIjoiVGVzdGthbGVuZGVyIiwiZCI6IkhhbWVkIEhpbXNlbGYifQ.N6xoHuea6j1nUimMeiHVtlWlfSKeA4hu-Oa9pb_AY-6zg_auCcJmH4iD94lU8lDXt11SXASF8DsGsysvhjKQuqTyQmPpcAvgfRv-Z1IjFCv_GK41Kdt77BeKTAY8vV4RpjNzNE6VKCUaT6bS88EAcEO6TvM1u4IzKrUExD0J-ik-YuJHOefbS7gQv7LFzMrLO3u3U_7fItKLPQodvFPpMxaBW2tRWJ0gdGNGN4kAvqzo8apayL6qGRDSgRRdLBD_6K43X6DVpYNmCUdldfzcrnsSTsEXWZu7zbSo44WLIReSDHQBx5xs628_AaMlkv8jSVhxf1r9ssUv8H1x2FA1ovzNEUrfp-0CSNb1hS_EOHWOsE4AAFH1bRU1VdVco2rglOqrYXSAmbtEOTO-3CbuwfpWJ8BWjVhmynsNznD5XQhYxqwyqHwfb_DAcewHK-aKvwyLOyT0MvDo5e285FCPkF2F1ZZzI5rDzVFrNLfzQOCYKpJQd0pHkvn0l0Zx-lFK18rbYnRQG12Bao6uKBE5dGCdQNSeaZZKGCN3IrzjUDt1dR2H36vTHB3D4nkkXzQR184cfG-Fb9IpLl1fJ-U6f2ah0TlOBCEYVcrCAqr1Y0PFgZlcv8StcNPhFgZimHbbGF5om0ZyGhltZurC1pVmKvgbHptxjUTtCErYi1FXwlE";
    public static final String VALID_TEST_RESULT_MEIN_CORONA_TEST = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJjIjoiZiIsImwiOiJNZWluIENvcm9uYSBTY2huZWxsdGVzdCIsIm4iOiJlM2FkY2RmZmM0ZGUzYWIzNDI1YmJjZTlmZDg3NzU4ZjMwNDk1OWVhNWE0YTc0MmEzMGE5MjlhODhmOWFhZjgzIiwidCI6MTYyMDgzNjA0NiwidiI6MiwiciI6Im4ifQ.HCoYdg9j8LL0QzIe2MJ_6H_GRtX4wTRbzZubaJW4eetcSAvaJChYs0Qj6cxFn8DkGtqYonSwTkkGoCniLuFez6fZKuc4FEEhMCtgaoqhT1XRtMokV7uMlnRQKE7rOsKHzMJi2FYNdDCKcIae4IbVwRaSCdaDsmNfXncBN_TFH7tm7Zmp6w56E6_CqSBP8HsuVK2NnKjFmAYjMQ1o_PVtgeYzc55nn5AzSBCVNIBHALUkbXzAbOh8Io4yHCxJqMEOoTuo6MAnD3w3FdQUddu73nZ7tVuS_lbRQ_WaXK4XfetuLlIWOu8tmIqE55JLZlzBbpPmG1eXe7gP2rKJypkmgHik99S7sBG-xBn_u1HmJwcbvEOnjTNK4o-UXyGBLQvOfBgngzLlFOUKrM_iQLIsBAycNlYdMgj2Xl8pww7NrM8Wfkk444l2CmIHFumJ5xaeyUD10tLMBfovW9XOHeqNDUAxivR9f63KEe9Wh3IrjhhT_fN5x1rrArtj1AzbHI_d27qC0lgOJI-BZmxTSUxBwyM2O1FLhu_ng4HU1A-Znc3pwZlcyrE1lWZbNsO6fQD_CPgf7dWUA_Nt_xMIpdnFDy4XBrxH6Ob0rmlWpNSW98Yd0e5h5DA8NF8Tc98owKTV04sReHze8Vve9pXAEavZKeg4vL71ZjGRr_2RZVFUTE0";
    public static final String VALID_TEST_RESULT_TEST_NOW = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMDIwMjA4MTg1MzAwYjMyMWVjZWEzNGIwN2YxZmFhYjRjMjRjYmE0MDYzMDk3NDUxMTZjOWM5YmEwNmRiOWYzMyIsInQiOjE2MjAzMzQ5NDMsImMiOiJvIiwiciI6Im4iLCJsIjoiVGVzdCBOT1chIEdtYkgiLCJkIjoiTWF4IE11c3Rlcm1hbm4ifQ.CS33_ocJeaPmReVPZ13I4QXyp2iXzd9uAcHKWT48Y2yXTUiiU2jUTGkuBCt71_0bAPK0e1HfEgOWWR5_L54PqOI9_YIaN-Bm-jgCpHw9ukgeFVhYFIBvk6hLniL5NIey0gVcNd9cO2YrvXeqVy6COHkf7P04qJqxPAD-dv9GWa4_B692qXPI4EvWu49GduFnQtrxMe_HZjnluobaRejC0UJQSjyio1mX4m8SFpQ_Xg0HBaNaMu-t396d6ICHOv5Mv4sL1u_FKTyDT-LsrCQpCmLvSzVdq8JLLPHLH1UapVdytu1DkMn2ehJz7PjTFjV3kG4V9lSrbW_TuloF9uenuX0DCA8iS__PMyY0EVDMH1UldtxUob41-Nb9ZIqgxWyhiUjet0i6siwi6wK3BmGqOxn0mb4JaNWNC3yovSLpAe_IHjuXiYTw86ZajR5LlmKewbFJno1lqmL7JWTAd5AeZPa44hcfMG0dcUl-6Qfv1yUsYAY_hA2JCO16cEuUSV67om7ENyE1a_zh-EgVtX_iuTgocZsnQsdKhzfUawIuKTWYd54wvsM44U-EGu1pqNaarZQOdputlkZCTEklkTPLH8PUl6t6TKtyzW7TseYeP7xCWg7WCQ6EMj_lJi46VNYc-_K30fBL9yWy-cGurt3_EY6Kin_QGvrVpgUO5xRk3tc";
    public static final String VALID_TEST_RESULT_COSIAMA = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiNmUwYzhhYzNhNzFmNGM3OWQwM2RlZGEyOTE1ODMzOGMxMzhkZjhkN2ExMGUzOTUyYmU5NTNkYWUyZWMxMjRiNyIsInQiOjE2MjIxMjExNDMsImMiOiJwIiwiciI6Im4iLCJsIjoiVGVzdHplbnRydW0gQXVnc2J1cmciLCJkIjoiVGhvbWFzIEh1YmVyIn0.ZcECEHuI0LQSObX8tUK0igJ1j9DTKoVKtTwYoRPrrmUsta1lol-eXg7YYZAHvf4CJc_y_Ros8CpbMFmZSuykOTnGE4mVm_7lv7brYQBABQf8GStrfGuGb9ZOsrHKTNzpbn1g9Qjt0cLTn5Cuw56ZbcohZuLcLHBpYB9OVClLR-z47BUwuJGNxPKNjec5rqoQJAOPj2evk6FtPHAyP9aFzFAEv-K0BGB9bOAkU3bZgZ0t64BqS_ZiA4l1Dp7q4yOdCxz8fTIEyruiotRpngFsQM05n6ey2DS6zPXyCL5mePVeM08MKlvAJqRBxCl5tOruF5OeTWZuWF3Ot2AKKDS7dPGYiJeqEV4ROM3IXpqz36ZHX9fzPT_L2DXqmChkkTq-g7yKXisQA4us1EXohHZB0LjgoQIMY7eWCnL_bW1Zv_2lluFf39XP3bcuS6nEkzbvMaSHSbwdwOkbJ2bFmIFhbJYL1iQV5rE8cEhefL198s4y08soh4qFXP2283jc1PvfWYMbE40epxvhFsWgVJ57WL540etXgmzt_F9JP8LvTZES-tqxFPdOWRypeR8xIE_DwzO5zSM4DidiZ5IUPSvovb-rIJACZKnteptAMt4draCHGLDulS6osVZH073cbiv_y7lo72_0i-GbI44I_CUGJ0x6hOoXDEQ_p3ha6pesypA";
    public static final String VALID_TEST_RESULT_COSIAMA_2 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiM2VlMTAxNWU1ZjQzOTZlN2ZjZmZiMDllZTk1ZjIyY2Q3NThiZDIzMDcyMDE0MzM1ZDNkZTk5MmU4OTIzYWQ4ZiIsInQiOjE2MjIxMjExNDMsImMiOiJmIiwiciI6Im4iLCJsIjoiIiwiZCI6IiJ9.gve_uSqkUOOboq6LB9B0e0okm1Vpw1Hrt1aqFLD7GJSt4U_sLT9OriMezlAIzhVH9tWwg9vS8O-wFWzT7Ig0oTAoLovHh--UA2DASTCEXaMsxrXMfUYoOAG0l4NRE0desA2oBVfpT4shlRFWRNrrNBGFB9ULnS61vNHBvbSk5adJMMHgq7nuBNY2CthzjaAdgZW-uE3hL4_c_KsCkziI44dpXwtnSxnqUIgCjC2nPuHMYNIlRfgV4yEaj6ie2_HvFAGMVd4hgewi2QRJdgTMzxoUc3_qTK06A9GQFiped6DxWHsYPCiMw1h4rXjpyZU7vd-EFmoJPSnEpiqOOPT1bqjvLnqmMhTVnrNA1LLGaop30Nb8dq3FpilpqYmlSfNbAyPD1ROPyH0KnqBCkWoBoMzDjfFRFHG4VxXW6lHy0a-C7gr85_Bw_h8MjVykaotCc2Z9V4u6Tq80W8p7rjR79twE5lNxl6cQlxuGJYLR3x3LRaxu2FNlgYj0a3SkvYC_3niSY3lj83mn3jPJD1ZfCWKbaIoJ8x0ZD9_NyKkuBnhgFsbp1uKyaZbYEZwhD7Etnx2xjv5n_vtNVwUDZN9OlOPgYFJMwjN2FLm2Jb6PdLn9URJk1tk7-VB2kLziYwu_iGckbZeh7D0uCWl7n4MnETPt0mWcFz2deYyCUaMsUAA";
    public static final String VALID_TEST_RESULT_COSIAMA_3 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiY2Q1ZDMzZjRiNmIzNzcwNTk2Y2Y5MDAzNzFjYWQzMTZiOGIyZmIzM2VjZDQ2ZjEzNjQ4NzE0ZTRiNTZiNjFjYyIsInQiOjE2MjIxMjExNDMsImMiOiJwIiwiciI6InAiLCJsIjoiIiwiZCI6IiJ9.oIchBuclrpt_rfgmWGoPtaGaxro38ggzi6eNd-iJTJZvL6myk8s2aZdiASgT6Fr6Nn_-hfLKpGNMyGBvOgLlFqYYZjtQKrakHqU06phUIf9iaN55IQIINMxZ-7AtUDD3mGvfTs8LGTjJpDdChBShFXQlHdy_Me5SV8f2H8igI7-S_-0mT2RB-cJd0qO1mLDCrTfYEhiPPfJM5DvK3al4i-nyoiDc2zFN9VErOEem5jY4qu7wJ4WTPxKhpmWdGAT8LEIIXhwoH5aTWr6Txnsu0tft-sNtjgnhrXLMaZhHN-ZLpceD9RX4kFabvyM2AZxlxKMGCCYIWoapDNqinp59oJ7bU-nnS48f6M5DkITn4CKnPZV_NRbueZWldeem8xgxtiE7WbTUo2cQwvrLsd6qp9bU1ECmqVoVr7s2V1ZNZ1-WIPO-S9EV_FVxpWzkwUo4QscFttVp3BXhjDYoi7CyO2UCVOTOio9mQmT3ebUKfAgsIEn5qI_xd30VybVToT-YZmpcB_Vi1VuF1RV1SCwstp7W1IPhQRz3yxOHNsN-aOHmRJg4tV-8-ClBjPR-dCgHkQ0fTvIoal4JIaXBmyFqRRgxR2BhxP5Ocwk3v2x24gwcBH4HSCyiWPYJrJVDIEBm1HEeAwhYsOOtUm1K8HjHJZPUe6_h8HuGwxIZzNbt3fo";
    public static final String VALID_TEST_RESULT_DRK_HANNOVER = "eyJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiZDRkMzBkYjZkMTM4M2YzOTgzOTE5MmIwNGQ5ZWVmM2ZjYzg0OTkxNGRhYjUxMzNiMjllNDdkNjU3MTBkMDQ2ZCIsInQiOjE2MjIxOTE0NTEsImMiOiJmIiwiciI6Im4iLCJsIjoiRFJLLVJlZ2lvbiBIYW5ub3ZlciBlLlYuIiwiZCI6Ik1vYmlsZXMgVGVzdHRlYW0iLCJlZCI6Ik9UcEI4YThENS8xNGludERLckppSllwa3gyZnJTa2NTTnREeS9CZElTUm90Zzc1Y3NkNWpuYjlCc29jZEo4UDFiYmlqNzZ1OGVzd01wTHhiRUsrbHJnR3lCanMxS1YwTU9yd0tzSlg4L0pMNWI5SU1LVjFCanFldklVaTl0c1JFUmZFUXlQUnFEWTd2QjVWOXM1dlZReXl4YkdIc3E2cGt0MGp3bmtGQ0FwRnBJWXNqNkJFTm9ZY0doenNQWEdRNnFLbGhyZHJhUHJhM2NaQ1NReTdwK0dJYTZxM21mUnEzc2RuUzZ4VTNsSWZKcHNGSUgzR1BQMk83WnBYblZLZkVneFVTM2dPU3RJa1hDUUhXWkFNaFVPUTU0M0NMTlA0eWVUVzRVdkdDdTdEdHMrd25nMzJNZGs5L2FkMGtSWFZhZ0oySnVtbUxITjFzUTM2MEJSSUpNZz09In0.idNYuZkhN_zR_sYbmtoctZDy_p5AIEmDczEi-J4MKdej--21yLzX9VK1TJiqb3NSMTwAGhIFCu7h400xL4hW3I9F1DKt8ukWs-fPlY-mNc0n9HcIUr07M__3X7i2xBkZkFPWkrHcOmXEm15ukImN-O_MLwKWNVdONrw5Dl5QkqJFkEK0Siwq6NIVuzEvsOAy-3orzzSkEg46dqH_RAWm3B7CVdv9cPpvLQNSuIaCp110aBDVtDKld9BXNPoMzZg8VgyWaqLPg4Np9ah1u1GJIxEY_LUDZHND4XjzsB-TqJ3fGYeKkY4Zd93QDK6CnC7LdHmEC0BxHH55zhj0lt-apQ";
    public static final String VALID_TEST_RESULT_PROBATIX = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiZjg0MGEyYjAwNGJhZjVlZTU5NTAxOGQ1YjA1MTZmNDRmM2ViYjUyNDcyNmNlOTAxYWJkYjE3ZDA2NTg5YjBjNyIsInQiOjE2MjI0Nzg1ODEsImMiOiJmIiwiciI6Im4iLCJsIjoiUHJvYmF0aXggVGVzdGNlbnRlciIsImQiOiJEci4gTWFyaXNhIiwiZWQiOiI5YjE3MDVkNWM5MWE4ZWFjZmQzNmQxMGU5NDI3MmYwNjpVVnMrYjZ0SnZhclBtK3VhYVhyamtyTHlxa1hYXC83ZFNONk1BaWlJRlwvXC9uUDRsc0QxWVdnN2Fvak55RjBXSHdHQW5icFdzQlwvSGExaW5EbDFJWDNtODNSOGhFdkl4cFwvakNBNzVMNWZwUW04PSJ9.rimSUbVQDCVr8kZD7E8U6ZFD9hiV5eFBDZTPTOohIHYFZXB2pjwTWMWd1FxFsNS7XpCvuRijiEJpXEV6K896M1H_9Ik_KiB2mP4i3wVRnIX7L2CcFW_pYlJzCT6y_IZ5i1X8FAFRz55oduYlEux6zX1SsYaeDO1Fuz7KiLpMhdYGg1pjZmvzxbAakbWzQmr2F0req4dGDZRNCgfBJuZlHuCULpdQXuDyAaKREiHa-x7FSne97KXnqwcgBvP6azwvnBpwlDcy7LK6-2p_DVHn4j1H-SeLlQaxP6_rW6pbC4G6SP5APO-4_chSCp1tEiPPgY3SccRV20DPjdWbdQQpPGftLxEcnmlc3NKND5OFG-22xnmrUMXGJP1YbwbEL249saXXGYBg7uHokrAaipNYETzWpfdyUXPztQk0oJd0XjbohI36mUuuHV2mvKRYEy7y2cs2HrCaD-2wtqGw1LvY9CZ1iob0Bi90Z0yJziu4D6LIdXJzcnvwyJUflvzejAToznf-rywUMSud2SthjescHOJYS_Kw3or7XWb5g8HUG-oX-Tetf-NtVscrnbl0WOSw9jXQbpSnOnXnxmPBLOpdI-o1WEsBnPCRtL7Rd6BezESay2uhtQShBhgzzEo4mMz3o5zGtK9eUiHzpgRjboZDijyHfnKK6vXg5jXUvmqwuZk";
    public static final String VALID_TEST_RESULT_NOQ = "eyJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiYTc4ZmJlMzY1YWI2NmM1ZWNjNzk1MWUwODJiZTRkY2QzMjIwZmFmNjQzN2M1OTBlYjY4OWY2ZDYxYTkzMjBiNSIsInQiOjE2MjIyMDQzNTMsImMiOiJmIiwiciI6InAiLCJsIjoiTGp1YmxqYW5hIiwiZCI6IkRyLiBaZHJhdmtvIn0.F4dO2zvBP_SmO0OYc48WsY2aHqZswycQ-miYWTVTL1JlaCi-RS_rmrHtoLa61RAhiswLWQi2hTKnpdIzKUfbshF9epZsno9LTjxrxhmlJPltSFXLFJKWh7OcAqzDvXR8qvYB5FCoxezcKBYFp_4ugLi1zNoTxzFM0gQw37oRg9jN1b21mBC5EcGfdeQ0vw6iqTcEmOIvs22Rri_EQLPzf25nJlaoKkG9Ms7lvwBQmgkbR13i3rpLc_oPeD1I5rGqDVZIpTkPFKRrcRpYfNTs0jQjBdprzx5yPBS1PopuSUo9CbcgjhYzfwn72PgqoppGRuAlnVrReJ9BEelKih_J5Q";
    public static final String VALID_TEST_RESULT_EM_GREEN_PASS = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiZmJiZDhjOTUwNjAyNzFkOGY5ZThmNWM0MGUwNjNhNjM1MWNmNzJhMWJjMjc0MDJkZDI5OTJkYmU2N2E4NzRlOCIsInQiOjE2MjM3ODM2MDAsImMiOiJlIiwiciI6InAiLCJsIjoiREZCIC0gVGVzdCBOT1chIFNjaG5lbGx0ZXN0emVudHJ1bSBGcmVpaGVpdHNoYWxsZSIsImQiOiJGcmFua3JlaWNoIC0gRGV1dHNjaGxhbmQifQ.v7JmIKhlvnq9Jgba0lJR3sTFrzwE7ohX8dIqPemYxUdW0aYMhB28Db5aCPioHXUSGRUztGp2QkK1zuY9pvLGAFu_mQoaa2koZUuYEQo6V8OOTLDU8PErNtPf35BoBjw2IXIHb79tyRFAAmglKUVOK9X0zb6jsVU1Xosphes7riBn0tVm0VHdRQ6HPJ8V-aMW5mE2oJE0srpnTU-5x4MKJ2F5xqu9HafzpFlpI-NJ52co6E33sKY3mRGvWQSfybwwrazFYRaxN_uzqmXEElqYR91ZDTTOXD88fR3e7tIS1oWMv3dYWfUApuIyFY49-hgSRWucfGOIRRqzMapqajR0zVxGrQv0kmuXtQyIArXxhR2zdOtJTExKmODnA6cqAQ7Wj6u7bSkp2Swtwhq3UlhJ35hHp4HyU1VybzY1wo_DjyAIgLDV-E7veYl7ghf980bqtOJdrqgiCc2ACd2Uu6aFqDAg8Xbbkn-gaKnCQvWWEuVwJIiZgIOLfII4GBtFJ1Ujq0hiqjPjefZv_2h7Obqgo4iC-8JbVLMPhpwdvSJpVKED1RyzMdFn5f6SHtwL4V3gs3H4CqstlhUjMKKvKDvZ010-9Volb4LNsZOY9cQ7EzRdQNa-XxKY-5CgJT0wxadUVzK9BEwY3BMLZqHVa_I2w25cBlne0M6QtD7Rqy7N17k";
    public static final String UNSUPPORTED_TEST_RESULT = "iLxiHVsrNhdXzP3hxFdwZwgYnt5FMF3Uz72bG8s1s+qWhsdH1xbxGVtHvsm/fDK/sYG3u/GJJwpWNWRglG8k4Jxr++Bx0pY+nv9joGbZneXKxRZzOtRZyqxF6pLk";
    public static final String UNVERIFIED_TEST_RESULT = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMjUwYmNjZmZkMWNiNWZlYWY0ODRmZGEzM2Y5NDdiM2Q4ZDcwMDA4M2ZmMjVlMGQ2NGQxMjk3NDQ0MWUzZTM4NCIsInQiOjE2MjA4MDIwMTQsImMiOiJvIiwiciI6Im4iLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJEci4gRGF2aWQiLCJlZCI6Iko5Mko3NUkyTXhWTzVVQUVSZHMrTDlybjZoZ0lndVNHUlVhT1RzdElGR1wvbHNDRTBpQ0VLTlZvR0JxMnlpeWpKck0yeFM4ZjhteXJnTUU2Z2V4bHdCeEFGbmpBQ1NoMmRTRU4zK0JiaUxqM1k3U2FmcTQraTJYa0RPZz09In0.n1I0PL7TA7o_8dkS1MM3rxvO3tJEgxz5N4YjPSeb7hRmyhIY-IFW0zMZxSZ4zl4vBUMgBAh5yQgseSlcLZX1xsBs6okr2nuaVtUGNOib79qSMfQBAksc3N47NCqD3VFyqJAzmQjw2KJNZA8dcGau72FIYI-U-9lxmD-J2VWw01kn8wNgGGaAd4xBp9DszEijvtOvr6B6OjyUzsGN-aI55ZCeIgoG50CtiwcM-3zW2s5kN_ph7RR_LRCVVo3oUjlxz3DPrukNOSivaDIZ55CXy-Q6VuSfSuywukw5fRHB8ROUbvjb0wL9uupPJyUhI_KkEKt894UweRJD895HH";

    private OpenTestCheckTestResultProvider testResultProvider;
    private RegistrationData registrationData;

    @Before
    public void setUp() {
        testResultProvider = new OpenTestCheckTestResultProvider();
        registrationData = new RegistrationData();
    }

    @Test
    public void canParse_validDataTicketIo_emitsTrue() {
        testResultProvider.canParse(VALID_TEST_RESULT_TICKET_IO)
                .test()
                .assertValue(true);
    }

    @Test
    public void canParse_validDataTicketIo2_emitsTrue() {
        testResultProvider.canParse(VALID_TEST_RESULT_TICKET_IO_2)
                .test()
                .assertValue(true);
    }

    @Test
    public void canParse_invalidData_emitsFalse() {
        testResultProvider.canParse(UNSUPPORTED_TEST_RESULT)
                .test()
                .assertValue(false);
    }

    @Test
    public void parse_validDataTicketIo_parsesData() {
        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO)
                .test()
                .assertValue(testResult -> {
                    assertEquals((Integer) 2, testResult.v);
                    assertEquals("16a3e4b92ca4660c41b88057276c35de38b6dfe7adced36cde1f079a6868a1a3", testResult.n);
                    assertEquals((Integer) 1620802052, testResult.t);
                    assertEquals("f", testResult.c);
                    assertEquals("n", testResult.r);
                    assertEquals("Covimedical GmbH", testResult.l);
                    assertEquals("Dr. David", testResult.d);
                    assertEquals("hojKXpQ+0DadjZYiTvKVZdzwmVT72Xu5GlYMsUbrO7c7DHYcW5cV6j8ZjZLEZFLOpKqS+P3fYsLBm34I1DDWOlGlz7TkPtNxn/rarsweP4nHeS8apUlPGpRp2TIvGQ==", testResult.ed);
                    return true;
                });
    }

    @Test
    public void parse_validDataTicketIo2_parsesData() {
        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO_2)
                .test()
                .assertValue(testResult -> {
                    assertEquals((Integer) 2, testResult.v);
                    assertEquals("a6a85d852e0591df36850e1f07511dea42acb0129c71df95e36aed78dae9e3a8", testResult.n);
                    assertEquals((Integer) 1620275740, testResult.t);
                    assertEquals("p", testResult.c);
                    assertEquals("p", testResult.r);
                    assertEquals("Covimedical GmbH", testResult.l);
                    assertEquals("Prof. Hans", testResult.d);
                    assertEquals("iLxiHVsrNhdXzP3hxFdwZwgYnt5FMF3Uz72bG8s1s+qWhsdH1xbxGVtHvsm/fDK/sYG3u/GJJwpWNWRglG8k4Jxr++Bx0pY+nv9joGbZneXKxRZzOtRZyqxF6pLk", testResult.ed);
                    return true;
                });
    }

    @Test
    public void parse_validDataEmGreenPass_correctType() {
        testResultProvider.parse(VALID_TEST_RESULT_EM_GREEN_PASS)
                .test()
                .assertValue(testResult -> {
                    assertEquals(TestResult.TYPE_GREEN_PASS, testResult.getLucaTestResult().getType());
                    return true;
                });
    }

    @Test
    public void parse_invalidData_emitsError() {
        testResultProvider.parse(UNSUPPORTED_TEST_RESULT)
                .test()
                .assertError(TestResultParsingException.class);
    }

    private void check(String firstName, String lastName, String encodedData) {
        registrationData.setFirstName(firstName);
        registrationData.setLastName(lastName);
        testResultProvider.parse(encodedData)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData)
                        .andThen(testResultProvider.verify(encodedData)))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_validDataTicketIo_completes() {
        check("Gianluca", "Frontzek", VALID_TEST_RESULT_TICKET_IO);
    }

    @Test
    public void validate_validDataWithSpecialCharTicketIo_completes() {
        check("Gianluca", "Förster", VALID_TEST_RESULT_TICKET_IO_SPECIAL_CHARS);
    }

    @Test
    public void validate_validDataSoda_completes() {
        check("Hamed", "Montazeri", VALID_TEST_RESULT_SODA);
    }

    @Test
    public void validate_validDataMeinCoronaTest_completes() {
        check("Sebastian", "Kowalski", VALID_TEST_RESULT_MEIN_CORONA_TEST);
    }

    @Test
    public void validate_validDataTestNow_completes() {
        check("Jannusch", "Franke", VALID_TEST_RESULT_TEST_NOW);
    }

    @Test
    public void verify_validDataCosiama_completes() {
        check("Åke", "Nordin", VALID_TEST_RESULT_COSIAMA);
    }

    @Test
    @Ignore("There is an issue in the Cosiama name hash calculation. Change with a valid QR Code and re-enable this test.")
    public void verify_validDataCosiama2_completes() {
        check("Agustín", "Gutiérrez Ureña", VALID_TEST_RESULT_COSIAMA_2);
    }

    @Test
    @Ignore("There is an issue in the Cosiama name hash calculation. Change with a valid QR Code and re-enable this test.")
    public void verify_validDataCosiama3_completes() {
        check("Max Josef", "Müller", VALID_TEST_RESULT_COSIAMA_3);
    }

    @Test
    public void verify_validDataDrkHannover_completes() {
        check("Max", "Mustermann", VALID_TEST_RESULT_DRK_HANNOVER);
    }

    @Test
    public void verify_validDataProbatix_completes() {
        check("Daniel", "Werner", VALID_TEST_RESULT_PROBATIX);
    }

    @Test
    public void verify_validDataNoQ_completes() {
        check("Janez", "ZupÈÑnčič", VALID_TEST_RESULT_NOQ);
    }

    private void checkForError(String firstName, String lastName, String encodedData, Class<TestResultVerificationException> expectedError) {
        registrationData.setFirstName(firstName);
        registrationData.setLastName(lastName);
        testResultProvider.parse(encodedData)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData)
                        .andThen(testResultProvider.verify(encodedData)))
                .test()
                .assertError(expectedError);
    }

    @Test
    public void validate_invalidDataMeinCoronaTest_fails() {
        checkForError("Sebastian", "Kowalski",
                VALID_TEST_RESULT_MEIN_CORONA_TEST + "invalid suffix", TestResultVerificationException.class);
    }

    @Test
    public void validate_nameMismatch_emitsError() {
        checkForError("Erika", "Mustermann", VALID_TEST_RESULT_TICKET_IO, TestResultVerificationException.class);
    }

    @Test
    public void validate_unverifiedData_emitsError() {
        checkForError("Jannusch", "Barnech", UNVERIFIED_TEST_RESULT, TestResultVerificationException.class);
    }

    @Test
    public void verify_ticketIoWithUrl_succeeds() {
        testResultProvider.verify(VALID_TEST_RESULT_TICKET_IO_2).test().assertComplete();
    }

    @Test
    public void verify_anyData_fails() {
        testResultProvider.verify("header.payload.signature")
                .test().assertError(TestResultVerificationException.class);
    }

    @Test
    public void generateNameHash_nameWithMultipleSpaces_removesChars() {
        registrationData.setFirstName("Rene");
        registrationData.setLastName("de Candido");
        Single<byte[]> hash = testResultProvider.HASH_PROVIDER.hash("RENEDECANDIDO".getBytes(StandardCharsets.US_ASCII));
        testResultProvider.generateNameHash(registrationData)
                .test().assertValue(Hex.bytesToStringLowercase(hash.blockingGet()));
    }

}