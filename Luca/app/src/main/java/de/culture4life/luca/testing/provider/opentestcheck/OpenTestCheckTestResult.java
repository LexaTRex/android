package de.culture4life.luca.testing.provider.opentestcheck;

import de.culture4life.luca.testing.TestResult;
import de.culture4life.luca.testing.provider.ProvidedTestResult;
import de.culture4life.luca.util.TimeUtil;

import java.util.UUID;

import androidx.annotation.NonNull;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import timber.log.Timber;

public class OpenTestCheckTestResult extends ProvidedTestResult {

    Integer v;
    String n;
    Integer t;
    String c;
    String r;
    String l;
    String d;
    String ed;

    public OpenTestCheckTestResult(@NonNull String encodedJwt) {
        String unsignedJwt = OpenTestCheckTestResultProvider.getUnsignedJwt(encodedJwt);
        Claims claims = Jwts.parserBuilder()
                .build()
                .parseClaimsJwt(unsignedJwt)
                .getBody();

        v = claims.get("v", Integer.class);
        if (v == null || v != 2) {
            throw new IllegalArgumentException("Invalid test version number: " + v);
        }

        // hashed name
        n = claims.get("n", String.class);

        // encrypted private data
        ed = claims.get("ed", String.class);

        // type
        c = claims.get("c", String.class);
        if ("f".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_FAST);
        } else if ("p".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_PCR);
        } else if ("e".equals(c) || "r".equals(c) || "v".equals(c)) {
            // probably EM green pass, will be checked with lab name
            lucaTestResult.setType(TestResult.TYPE_UNKNOWN);
        } else if ("o".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_UNKNOWN);
        } else {
            throw new IllegalArgumentException("Invalid test category: " + c);
        }

        // outcome
        r = claims.get("r", String.class);
        if ("n".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_NEGATIVE);
        } else if ("p".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_POSITIVE);
        } else if ("u".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_UNKNOWN);
        } else {
            throw new IllegalStateException("Invalid test result: " + r);
        }

        // timestamps
        t = claims.get("t", Integer.class);
        if (t == null || t == 0) {
            throw new IllegalArgumentException("Invalid test timestamp: " + t);
        }
        lucaTestResult.setResultTimestamp(TimeUtil.convertFromUnixTimestamp(t).blockingGet());
        lucaTestResult.setTestingTimestamp(lucaTestResult.getResultTimestamp());
        lucaTestResult.setImportTimestamp(System.currentTimeMillis());

        // lab name
        l = claims.get("l", String.class);
        if (l == null || l.isEmpty()) {
            Timber.w("Missing lab name");
        }
        l = l.trim().replaceAll(" {2,}", System.lineSeparator());
        lucaTestResult.setLabName(l);
        if (l.startsWith("DFB") && lucaTestResult.getType() == TestResult.TYPE_UNKNOWN) {
            lucaTestResult.setType(TestResult.TYPE_GREEN_PASS);
        }

        // lab doctor name
        d = claims.get("d", String.class);
        if (d == null || d.isEmpty()) {
            Timber.w("Missing lab doctor name");
        }
        lucaTestResult.setLabDoctorName(d);

        lucaTestResult.setEncodedData(encodedJwt);
        lucaTestResult.setHashableEncodedData(getHeaderAndBody(encodedJwt));
        lucaTestResult.setId(UUID.nameUUIDFromBytes(lucaTestResult.getHashableEncodedData().getBytes()).toString());
    }

    protected static String getHeaderAndBody(@NonNull String encodedJwt) {
        String[] parts = encodedJwt.split("\\.");
        return parts[0] + "." + parts[1];
    }

}
