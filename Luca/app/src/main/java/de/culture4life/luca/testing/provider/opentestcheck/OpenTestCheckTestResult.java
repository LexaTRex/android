package de.culture4life.luca.testing.provider.opentestcheck;

import com.auth0.jwt.JWT;
import com.auth0.jwt.interfaces.DecodedJWT;

import de.culture4life.luca.testing.TestResult;
import de.culture4life.luca.testing.provider.ProvidedTestResult;
import de.culture4life.luca.util.TimeUtil;

import java.util.UUID;

import androidx.annotation.NonNull;

public class OpenTestCheckTestResult extends ProvidedTestResult {

    Integer v;
    String n;
    Integer t;
    String c;
    String r;
    String l;
    String d;
    String ed;

    public OpenTestCheckTestResult(@NonNull String encodedJwt) {
        DecodedJWT jwt = JWT.decode(encodedJwt);

        v = jwt.getClaim("v").asInt();
        if (v == null || v != 2) {
            throw new IllegalArgumentException("Invalid test version number: " + v);
        }

        // hashed name
        n = jwt.getClaim("n").asString();

        // encrypted private data
        ed = jwt.getClaim("ed").asString();

        // type
        c = jwt.getClaim("c").asString();
        if ("f".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_FAST);
        } else if ("p".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_PCR);
        } else if ("o".equals(c)) {
            lucaTestResult.setType(TestResult.TYPE_UNKNOWN);
        } else {
            throw new IllegalArgumentException("Invalid test category: " + c);
        }

        // outcome
        r = jwt.getClaim("r").asString();
        if ("n".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_NEGATIVE);
        } else if ("p".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_POSITIVE);
        } else if ("u".equals(r)) {
            lucaTestResult.setOutcome(TestResult.OUTCOME_UNKNOWN);
        } else {
            throw new IllegalStateException("Invalid test result: " + r);
        }

        // timestamps
        t = jwt.getClaim("t").asInt();
        if (t == null || t == 0) {
            throw new IllegalArgumentException("Invalid test timestamp: " + t);
        }
        lucaTestResult.setResultTimestamp(TimeUtil.convertFromUnixTimestamp(t).blockingGet());
        lucaTestResult.setTestingTimestamp(lucaTestResult.getResultTimestamp());
        lucaTestResult.setImportTimestamp(System.currentTimeMillis());

        // lab name
        l = jwt.getClaim("l").asString();
        if (l == null || l.isEmpty()) {
            throw new IllegalArgumentException("Invalid lab name: " + l);
        }
        lucaTestResult.setLabName(l);

        // lab doctor name
        d = jwt.getClaim("d").asString();
        if (d == null || d.isEmpty()) {
            throw new IllegalArgumentException("Invalid lab doctor name: " + d);
        }
        lucaTestResult.setLabDoctorName(d);

        lucaTestResult.setId(UUID.nameUUIDFromBytes(encodedJwt.getBytes()).toString());
        lucaTestResult.setEncodedData(encodedJwt);
    }

}
